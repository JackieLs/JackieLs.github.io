<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
      Webpack 优化技巧 (1) | Jackie.Ls&#39; Blog 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="Jackie.Ls">
    
    

    <meta name="description" content="webpack 太强大了，以至于不知道该怎么用了。今天就来讲一点基本的 webpack 优化相关技巧。  我们的目标  创建一个 webpack-demo，这个 demo 包含以下功能。  按需加载 代码分割 公共代码抽离 使用 hash 进行文件标识，方便缓存  本文以 webpack3 为基础，因为很多原理性的东西要在 webpack3 中讲解，webpack4 做了很多默认的优化，具体内容">
<meta name="keywords" content="javascript,nodejs,webpack">
<meta property="og:type" content="article">
<meta property="og:title" content="Webpack 优化技巧 (1) | Jackie.Ls&#39; Blog">
<meta property="og:url" content="https://jackiels.github.io/2018/03/02/Webpack-优化技巧(1)/index.html">
<meta property="og:site_name" content="Jackie.Ls&#39; Blog">
<meta property="og:description" content="webpack 太强大了，以至于不知道该怎么用了。今天就来讲一点基本的 webpack 优化相关技巧。  我们的目标  创建一个 webpack-demo，这个 demo 包含以下功能。  按需加载 代码分割 公共代码抽离 使用 hash 进行文件标识，方便缓存  本文以 webpack3 为基础，因为很多原理性的东西要在 webpack3 中讲解，webpack4 做了很多默认的优化，具体内容">
<meta property="og:locale" content="en-US">
<meta property="og:updated_time" content="2018-03-06T10:04:52.360Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Webpack 优化技巧 (1) | Jackie.Ls&#39; Blog">
<meta name="twitter:description" content="webpack 太强大了，以至于不知道该怎么用了。今天就来讲一点基本的 webpack 优化相关技巧。  我们的目标  创建一个 webpack-demo，这个 demo 包含以下功能。  按需加载 代码分割 公共代码抽离 使用 hash 进行文件标识，方便缓存  本文以 webpack3 为基础，因为很多原理性的东西要在 webpack3 中讲解，webpack4 做了很多默认的优化，具体内容">
    
    
    
      <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <link rel="stylesheet" href="/css/uno.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/archive.css">
    <link rel="stylesheet" href="/css/china-social-icon.css">

</head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

  
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">Jackie.Ls&#39; Blog</a></h1>
        <hr class="panel-cover__divider" />

        
        <p class="panel-cover__description">
          FE Thug Life
        </p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />
        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">Blog</a></li>
              
                
                <li class="navigation__item"><a href="/about" title="" class="">About</a></li>
              
                
                <li class="navigation__item"><a href="/archive" title="" class="">Archive</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h1 class="post-title">Webpack 优化技巧 (1)</h1>

    

    <div class="post-meta">
      <time datetime="2018-03-02" class="post-meta__date date">2018-03-02</time> 

      <span class="post-meta__tags tags">

          
            <font class="categories">
            &#8226; 分类:
            <a class="categories-link" href="/categories/大前端/">大前端</a>
            </font>
          

          
             &#8226; 标签:
            <font class="tags">
              <a class="tags-link" href="/tags/javascript/">javascript</a>, <a class="tags-link" href="/tags/nodejs/">nodejs</a>, <a class="tags-link" href="/tags/webpack/">webpack</a>
            </font>
          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <blockquote>
<p>webpack 太强大了，以至于不知道该怎么用了。今天就来讲一点基本的 webpack 优化相关技巧。</p>
</blockquote>
<h2 id="我们的目标"><a href="# 我们的目标" class="headerlink" title="我们的目标"></a>我们的目标 </h2><p> 创建一个 webpack-demo，这个 demo 包含以下功能。</p>
<ul>
<li>按需加载</li>
<li>代码分割</li>
<li>公共代码抽离</li>
<li>使用 hash 进行文件标识，方便缓存</li>
</ul>
<p>本文以 webpack3 为基础，因为很多原理性的东西要在 webpack3 中讲解，webpack4 做了很多默认的优化，具体内容不是很好说清楚。</p>
<h2 id="先建立一个项目"><a href="# 先建立一个项目" class="headerlink" title="先建立一个项目"></a>先建立一个项目</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">webpack-demo</span><br><span class="line">  ├── index.html              //html 页面</span><br><span class="line">  ├── node_modules            //node_modules</span><br><span class="line">  ├── tools                   // 构建工具文件夹</span><br><span class="line">  │   ├── webpack.config.js   //webpack 配置文件</span><br><span class="line">  │   └── build.js            // 运行 webpack-build 脚本的文件</span><br><span class="line">  ├── src                     // 所有代码源文件夹</span><br><span class="line">  │   └── main.js             // 入口文件</span><br><span class="line">  └── package.json            //package.json</span><br></pre></td></tr></table></figure>
<p>看一下<code>package.json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"webpack-demo"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"0.0.0"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">"webpack-demo"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">  	<span class="attr">"build"</span>: <span class="string">"node tools/build"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"lodash"</span>: <span class="string">"^4.17.5"</span>,</span><br><span class="line">    <span class="attr">"webpack"</span>: <span class="string">"^4.0.1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>scripts</code> 的<code>build</code>脚本中，没有使用 <code>webpack -c tools/webpack.config.js</code> 这种方式进行运行，是因为在 webpack4 中 <code>webpack</code> 把<code>webpack-cli</code>单独分离出来了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">The CLI moved into a separate package: webpack-cli.</span><br><span class="line">Please install &apos;webpack-cli&apos; in addition to webpack itself to use the CLI.</span><br><span class="line">-&gt; When using npm: npm install webpack-cli -D</span><br><span class="line">-&gt; When using yarn: yarn add webpack-cli -D</span><br></pre></td></tr></table></figure></p>
<p>PS:<code>webpack-cli</code>的好处就是把构建过程可以很友好的打印出来，不用我们自己在 stats 里面格式化。</p>
<p>每次构建的时候我们就是用<code>npm run build</code>。我们来看看 build.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'./webpack.config'</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">const</span> complier = webpack(config)</span><br><span class="line">	complier.run(<span class="function">(<span class="params">err, stats</span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (err) &#123;</span><br><span class="line">			<span class="built_in">console</span>.log(err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">const</span> log = stats.toString(&#123;</span><br><span class="line">			colors: <span class="literal">true</span>,</span><br><span class="line">			chunks: <span class="literal">false</span>,</span><br><span class="line">			modules: <span class="literal">false</span></span><br><span class="line">		&#125;)</span><br><span class="line">		<span class="built_in">console</span>.log(log)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line">start()</span><br></pre></td></tr></table></figure></p>
<p>我觉得这是史上最简单的 webpack 构建脚本了，没有之一。再来看看史上最简单的<code>webpack.config.js</code><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">	context: __dirname,</span><br><span class="line">	entry: <span class="string">'../src/main.js'</span>,</span><br><span class="line">	output: &#123;</span><br><span class="line">		filename: <span class="string">'[name].js'</span>,</span><br><span class="line">		path: path.resolve(__dirname, <span class="string">'../dist'</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = config</span><br></pre></td></tr></table></figure></p>
<p>入口出口我就不想解释了，就是我从哪里来，要到哪里去。<br>context 解释一下：中文就是上下文，也就是这个 config 执行的上下文，设置这个的目的是为了让所有的相对路径都是相对于当前这个 config 文件所在的路径，这样方便管理，否则你会发现这个 config 的路径是构建脚本运行的路径也就是 <code>package.json</code> 的路径。</p>
<p>我们在 src 下创建两个文件：chunkA.js, chunkB.js<br>三个文件分别如下<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">'lodash'</span></span><br><span class="line"><span class="keyword">import</span> chunkA <span class="keyword">from</span> <span class="string">'./chunkA'</span></span><br><span class="line"><span class="keyword">import</span> chunkB <span class="keyword">from</span> <span class="string">'./chunkB'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'This is ChunkA.'</span>,chunkA)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'This is ChunkB.'</span>,chunkB)</span><br><span class="line"></span><br><span class="line"><span class="comment">//ChunkA.js</span></span><br><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">'lodash'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="string">'ChunkA'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ChunkB.js</span></span><br><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">'lodash'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="string">'ChunkB'</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到 <code>lodash</code> 被引用了三次</p>
<p>在 SPA(Single Page Application)中，我们希望实现这样的一种需求：</p>
<ul>
<li>每访问一个页面的时候，只加载这部分的代码(按需加载，代码分割)，如果有缓存则读取缓存</li>
<li>让所有代码的公共部分只请求一次(代码抽离)</li>
</ul>
<p>这就需要在打包的时候打出来的时候代码像这样：ChunkA.js, ChunkB.js, common.js, main.js<br>main.js 是首次打开网站的程序，ChunkA.js 是 /A 路径的依赖包 (B 同 A)，common.js 是公共包。<br> 我们来修改一下<code>webpack.config</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">	context: __dirname,</span><br><span class="line">	entry: &#123;</span><br><span class="line">		main: <span class="string">'../src/main.js'</span>,</span><br><span class="line">		chunkA: <span class="string">'../src/chunkA.js'</span>,</span><br><span class="line">		chunkB: <span class="string">'../src/chunkB.js'</span>,</span><br><span class="line">		common: <span class="string">'lodash'</span></span><br><span class="line">	&#125;,</span><br><span class="line">	output: &#123;</span><br><span class="line">		filename: <span class="string">'[name].js'</span>,</span><br><span class="line">		path: path.resolve(__dirname, <span class="string">'../dist'</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = config</span><br></pre></td></tr></table></figure>
<p>我想发个表情，就是愣住了的表情。我们来看看结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Hash: 7f1d72a2913e57a9454a</span><br><span class="line">Version: webpack 3.11.0</span><br><span class="line">Time: 594ms</span><br><span class="line">    Asset    Size      Chunks                    Chunk Names</span><br><span class="line">  main.js  545 kB  0, 1, 2, 3  [emitted]  [big]  main</span><br><span class="line">chunkB.js  544 kB        1, 3  [emitted]  [big]  chunkB</span><br><span class="line">chunkA.js  544 kB        2, 3  [emitted]  [big]  chunkA</span><br><span class="line">common.js  544 kB           3  [emitted]  [big]  common</span><br></pre></td></tr></table></figure></p>
<p>直上直下啊，什么抽离，什么打包，都没有啊，一样大？具体是因为啥？因为 <strong>如果入口 chunks 之间包含重复的模块，那些重复模块都会被引入到各个 bundle 中 </strong>。<br> 所以，有问题，我们得改一下。祭出宝刀<code>CommonsChunkPlugin</code>。</p>
<blockquote>
<p>这个插件在上古时代，是一个单独的 plugin，现在已经被 webpack 给征收了。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">	context: __dirname,</span><br><span class="line">	entry: &#123; <span class="comment">// 多入口</span></span><br><span class="line">		main: <span class="string">'../src/main.js'</span>,</span><br><span class="line">		chunkA: <span class="string">'../src/chunkA.js'</span>,</span><br><span class="line">		chunkB: <span class="string">'../src/chunkB.js'</span>,</span><br><span class="line">		common: <span class="string">'lodash'</span></span><br><span class="line">	&#125;,</span><br><span class="line">	output: &#123;</span><br><span class="line">		filename: <span class="string">'[name].js'</span>,</span><br><span class="line">		path: path.resolve(__dirname, <span class="string">'../dist'</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	plugins: [</span><br><span class="line">		<span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;  <span class="comment">//webpack 4 里面没有这个东西咯，到时候会出一篇新的文档讲一些区别。</span></span><br><span class="line">			name: <span class="string">'common'</span></span><br><span class="line">		&#125;)</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = config</span><br></pre></td></tr></table></figure>
<p>输出结果如下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Hash: 0a4ef814b0f418065565</span><br><span class="line">Version: webpack 3.11.0</span><br><span class="line">Time: 442ms</span><br><span class="line">    Asset       Size   Chunks                    Chunk Names</span><br><span class="line">  main.js    1.73 kB  0, 1, 2  [emitted]         main</span><br><span class="line">chunkB.js  505 bytes        1  [emitted]         chunkB</span><br><span class="line">chunkA.js  509 bytes        2  [emitted]         chunkA</span><br><span class="line">common.js     545 kB        3  [emitted]  [big]  common</span><br></pre></td></tr></table></figure></p>
<p>我们可以很清楚的看到, 小了很多，这样在网页中四个文件都引人进去之后，lodash 也只会被加载一次，不会重复加载。<br>但是这就完了？？？<br>我们看看目标</p>
<ul>
<li>按需加载</li>
<li><del>代码分割</del></li>
<li><del>公共代码抽离</del></li>
<li>使用 hash 进行文件标识，方便缓存</li>
</ul>
<p>革命尚未成功，同志还需努力，按需加载以及，缓存命中，关于缓存详细可以查看我的这篇文章 <a href="/2018/03/02/%E5%8D%8F%E5%95%86%E7%BC%93%E5%AD%98%E5%92%8C%E5%BC%BA%E5%88%B6%E7%BC%93%E5%AD%98%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/">304 缓存和强制缓存的基本知识</a>。<br> 我们希望我们的缓存是这样的：<strong>哪里修改， 哪里就不缓存，哪里没有修改，我就读取本地缓存</strong>。于是我们需要对每个 chunk 添加一个 hash 值，如果这个 chunk 我一点都没动，hash 就不变，动了就重新进行 hash。我们来实验一下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">	context: __dirname,</span><br><span class="line">	entry: &#123;</span><br><span class="line">		main: <span class="string">'../src/main.js'</span>,</span><br><span class="line">		chunkA: <span class="string">'../src/chunkA.js'</span>,</span><br><span class="line">		chunkB: <span class="string">'../src/chunkB.js'</span>,</span><br><span class="line">		common: <span class="string">'lodash'</span></span><br><span class="line">	&#125;,</span><br><span class="line">	output: &#123;</span><br><span class="line">		filename: <span class="string">'[name].[id].[chunkhash].js'</span>, <span class="comment">// 方便查看 chunk.id</span></span><br><span class="line">		path: path.resolve(__dirname, <span class="string">'../dist'</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	plugins: [</span><br><span class="line">		<span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">			name: <span class="string">'common'</span></span><br><span class="line">		&#125;)</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Hash: 93949866421bf3e78192</span><br><span class="line">Version: webpack 3.11.0</span><br><span class="line">Time: 493ms</span><br><span class="line">                           Asset       Size   Chunks                    Chunk Names</span><br><span class="line">  main.0.b5fa0d43d47640136052.js    1.73 kB  0, 1, 2  [emitted]         main</span><br><span class="line">chunkB.1.67669df697f978f44cc6.js  501 bytes        1  [emitted]         chunkB</span><br><span class="line">chunkA.2.ed161bf7774330c2e33f.js  507 bytes        2  [emitted]         chunkA</span><br><span class="line">common.3.5ac5829d3f4fca2c9437.js     545 kB        3  [emitted]  [big]  common</span><br></pre></td></tr></table></figure></p>
<p>我们修改一下 chunkA, 随便加一行就行，结果如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Hash: 8529bc4b684315c2d684</span><br><span class="line">Version: webpack 3.11.0</span><br><span class="line">Time: 507ms</span><br><span class="line">                           Asset       Size   Chunks                    Chunk Names</span><br><span class="line">  main.0.23390590c1288b351411.js    1.74 kB  0, 1, 2  [emitted]         main</span><br><span class="line">chunkB.1.67669df697f978f44cc6.js  501 bytes        1  [emitted]         chunkB</span><br><span class="line">chunkA.2.6ebaf43e337470d9cbe6.js  520 bytes        2  [emitted]         chunkA</span><br><span class="line">common.3.5ac5829d3f4fca2c9437.js     545 kB        3  [emitted]  [big]  common</span><br></pre></td></tr></table></figure></p>
<p>你会发现，太好了 chunkB 和 common 公共模块都没有变化。于是缓存这个问题我们解决了一半，但是为什么 main 模块的 hash 变了呢？WTF? 明明没改啊。问题就在于代码分割，在 webpack 的日志里，chunks 那一列对应的是当前这个 chunk 模块里面包含了哪几个 chunk 的 id，我在前面已经吧每个 id 添加到文件名里了，所以可以清晰地看到，<code>main.0.b5fa0d43d47640136052.js</code>这个包里面包含了 0,1,2 这三个 chunk，2 就是我们刚刚修改的 chunkA，所以 chunkA 变了，main 自然就变了。很明显，这不是我们想要的，我只希望 chunkA 的 hash 改变。那么就来插一句很重要的的题外话————动态引用。<br>我们先来修改一下 main.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">'lodash'</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getComponentA</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">import</span>(<span class="comment">/* webpackChunkName: "chunkA" */</span><span class="string">'./chunkA'</span>).then(<span class="function"><span class="params">chunkA</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'This is ChunkA.'</span>,chunkA)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="comment">// 这个 webpackChunkName 的注释是为了表明 chunkA 的 name 的，否则 name 默认是 chunk 的 id。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getComponentB</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">import</span>(<span class="comment">/* webpackChunkName: "chunkB" */</span><span class="string">'./chunkB'</span>).then(<span class="function"><span class="params">chunkB</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'This is ChunkB.'</span>,chunkB)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这是使用 es7 的 <code>import</code> 方法 (<a href="https://doc.webpack-china.org/guides/code-splitting/#%E5%8A%A8%E6%80%81%E5%AF%BC%E5%85%A5-dynamic-imports-" target="_blank" rel="noopener">webpack 原文链接点我</a>)，目前这个方法还是在提议阶段，需要使用<a href="https://babeljs.io/docs/plugins/syntax-dynamic-import/#installation" target="_blank" rel="noopener">babel 动态 import 插件</a>。跟<code>require</code> 一样，只不过 <code>require</code> 的结果是同步的，<code>import</code>是一个异步的<code>Promise</code>。我们来看一下结合 React-Router 的实践。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;Route path=<span class="string">"/A"</span> getComponent=&#123;</span><br><span class="line">	(location, callback) =&gt; &#123;</span><br><span class="line">		<span class="built_in">require</span>.ensure([], <span class="built_in">require</span> =&gt; &#123;</span><br><span class="line">			callback(<span class="literal">null</span>, <span class="built_in">require</span>(<span class="string">'./chunkA'</span>))</span><br><span class="line">		&#125;, <span class="string">'chunkA'</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;/&gt;</span><br></pre></td></tr></table></figure></p>
<p>总而言之，使用动态引用之后，webpack 会自动帮我们把这些动态引入的文件，变成 main.js 依赖的 chunk 打包起来，所以就不用我们在 entry 中手动进行打包，从 entry 中删掉 chunkA、chunkB，同时我们还要添加一个新属性叫<code>chunkFilename</code>，此选项决定了非入口(non-entry) chunk 文件的名称(也就是动态引入的那些)。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">	context: __dirname,</span><br><span class="line">	entry: &#123;</span><br><span class="line">		main: <span class="string">'../src/main.js'</span>,</span><br><span class="line">		common: <span class="string">'lodash'</span></span><br><span class="line">	&#125;,</span><br><span class="line">	output: &#123;</span><br><span class="line">		filename: <span class="string">'[name].[id].[chunkhash].js'</span>,</span><br><span class="line">		chunkFilename: <span class="string">'[name].[id].[chunkhash].js'</span>,</span><br><span class="line">		path: path.resolve(__dirname, <span class="string">'../dist'</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	plugins: [</span><br><span class="line">		<span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">			name: <span class="string">'common'</span></span><br><span class="line">		&#125;)</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结果如下，可以看到，每个 chunk 都是一个单独的依赖了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Hash: 31ffd0d60e19dd8b92af</span><br><span class="line">Version: webpack 3.11.0</span><br><span class="line">Time: 479ms</span><br><span class="line">                           Asset       Size  Chunks                    Chunk Names</span><br><span class="line">chunkB.0.fb17bada7e6534af447c.js  497 bytes       0  [emitted]         chunkB</span><br><span class="line">chunkA.1.08ae06e62c72fac989a0.js  497 bytes       1  [emitted]         chunkA</span><br><span class="line">  main.2.406e7cb906708fa4c47c.js  789 bytes       2  [emitted]         main</span><br><span class="line">common.3.ee05d61a552532757e3c.js     547 kB       3  [emitted]  [big]  common</span><br></pre></td></tr></table></figure></p>
<p>修改一下 chunkA<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Hash: 15ab13b418bf05896f74</span><br><span class="line">Version: webpack 3.11.0</span><br><span class="line">Time: 434ms</span><br><span class="line">                           Asset       Size  Chunks                    Chunk Names</span><br><span class="line">chunkB.0.fb17bada7e6534af447c.js  497 bytes       0  [emitted]         chunkB</span><br><span class="line">chunkA.1.d8426cb1d8ed3d5ff7bc.js  510 bytes       1  [emitted]         chunkA</span><br><span class="line">  main.2.406e7cb906708fa4c47c.js  789 bytes       2  [emitted]         main</span><br><span class="line">common.3.06fc2e3123be39d2e904.js     547 kB       3  [emitted]  [big]  common</span><br></pre></td></tr></table></figure></p>
<p>我们会发现 OK，chunkB 没变，chunkA 变了，main 没变，我 F…佛慈悲，common 的 hash 怎么变了？？？？？？<strong>这是因为 webpack 在入口 chunk 中，包含了某些样板(boilerplate)，特别是 runtime 和 manifest。</strong> 这个时候我们就要继续祭出宝刀<code>CommonsChunkPlugin</code>。原文引用如下</p>
<blockquote>
<p>CommonsChunkPlugin 有一个较少有人知道的功能是，能够在每次修改后的构建结果中，将 webpack 的样板 (boilerplate) 和 manifest 提取出来。</p>
</blockquote>
<p>接着改…..<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">	context: __dirname,</span><br><span class="line">	entry: &#123;</span><br><span class="line">		main: <span class="string">'../src/main.js'</span>,</span><br><span class="line">		common: <span class="string">'lodash'</span></span><br><span class="line">	&#125;,</span><br><span class="line">	output: &#123;</span><br><span class="line">		filename: <span class="string">'[name].[id].[chunkhash].js'</span>,</span><br><span class="line">		chunkFilename: <span class="string">'[name].[id].[chunkhash].js'</span>,</span><br><span class="line">		path: path.resolve(__dirname, <span class="string">'../dist'</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	plugins: [</span><br><span class="line">		<span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">			name: [<span class="string">'common'</span>, <span class="string">'manifest'</span>]</span><br><span class="line">		&#125;)</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>来看结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Hash: 2b1b2e10560183cb4668</span><br><span class="line">Version: webpack 3.11.0</span><br><span class="line">Time: 479ms</span><br><span class="line">                             Asset       Size  Chunks                    Chunk Names</span><br><span class="line">  chunkB.0.fb17bada7e6534af447c.js  497 bytes       0  [emitted]         chunkB</span><br><span class="line">  chunkA.1.08ae06e62c72fac989a0.js  497 bytes       1  [emitted]         chunkA</span><br><span class="line">  common.2.3d313129f7c2b7b8c8c1.js     541 kB       2  [emitted]  [big]  common</span><br><span class="line">    main.3.95a396fd8041103a4bc4.js  789 bytes       3  [emitted]         main</span><br><span class="line">manifest.4.95ae15bc3abbd7e7641b.js     5.9 kB       4  [emitted]         manifest</span><br></pre></td></tr></table></figure></p>
<p>改一下 chunkA。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Hash: cc76c630ca269d79188d</span><br><span class="line">Version: webpack 3.11.0</span><br><span class="line">Time: 464ms</span><br><span class="line">                             Asset       Size  Chunks                    Chunk Names</span><br><span class="line">  chunkB.0.fb17bada7e6534af447c.js  497 bytes       0  [emitted]         chunkB</span><br><span class="line">  chunkA.1.d8426cb1d8ed3d5ff7bc.js  510 bytes       1  [emitted]         chunkA</span><br><span class="line">  common.2.3d313129f7c2b7b8c8c1.js     541 kB       2  [emitted]  [big]  common</span><br><span class="line">    main.3.95a396fd8041103a4bc4.js  789 bytes       3  [emitted]         main</span><br><span class="line">manifest.4.2a56d7ac08aa046b3e47.js     5.9 kB       4  [emitted]         manifest</span><br></pre></td></tr></table></figure></p>
<p>我们会发现 OK，chunkB 没变，chunkA 变了，common 没变，main 没变，manifest 变了。好了，这样我们就放心了，经过一番的分割，hash 之后我们来看看目标。</p>
<ul>
<li><del>按需加载</del></li>
<li><del>代码分割</del></li>
<li><del>公共代码抽离</del></li>
<li><del>使用 hash 进行文件标识，方便缓存</del></li>
</ul>
<p>回顾一下，最开始我们 build 的结果，每个文件都是 500 多 K，现在所有文件加到一起差不多 500 多 K，最开始的每个文件都包含了所有的 chunk，现在每个 chunk 都是分离的，对资源进行了极大的优化(不包括压缩等)。</p>
<h2 id="总结"><a href="# 总结" class="headerlink" title="总结"></a>总结 </h2><p> 这次我们没有使用任何 loader 进行了一些基本的配置优化，几乎任何一个 SPA 项目中，今天说的这些优化都是要做的，代码分割，按需加载，模块抽离，缓存命中。希望读者能明白，并且最后可以脱离本文进行徒手书写。下一次会结合 React 介绍 loader 和一些常用的三方插件。</p>
<h2 id="参考"><a href="# 参考" class="headerlink" title="参考"></a>参考 </h2><p><a href="https://doc.webpack-china.org/" target="_blank" rel="noopener">Webpack 官方文档译文</a><br><a href="https://github.com/webpack/webpack/issues/1949" target="_blank" rel="noopener">import() 动态引用的 chunkName 设置</a></p>

  </section>

  <section class="post-comments">

    <!-- 将评论系统（例如Disqus、多说、友言、畅言等）提供的代码片段粘贴在这里 -->
    
</section>


</article>


            <footer class="footer">

    <span class="footer__copyright">&copy; 2018-2020. | Powered By <a href="https://hexo.io/">Hexo</a>| Theme <a href="https://github.com/someus/huno">Huno</a></span>
    <div style="margin-top: 16px;">
    	<!-- Place this tag where you want the button to render. -->
		<a class="github-button" href="https://github.com/JackieLs" aria-label="Follow @JackieLs on GitHub">Follow @JackieLs</a>
		<!-- Place this tag where you want the button to render. -->
		<a class="github-button" href="https://github.com/JackieLs/JackieLs.github.io" data-icon="octicon-star" aria-label="Star JackieLs/JackieLs.github.io on GitHub">Star</a>
		<!-- Place this tag where you want the button to render. -->
		<a class="github-button" href="https://github.com/JackieLs/JackieLs.github.io/issues" data-icon="octicon-issue-opened" aria-label="Issue JackieLs/JackieLs.github.io on GitHub">Issue</a>
    </div>
</footer>
        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    

    
    

    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    <script>
/* 百度 统计 */
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b80228413e73eb76b88cba9e36b404b7";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->
    <!-- Place this tag in your head or just before your close body tag. -->
<script async defer src="https://buttons.github.io/buttons.js"></script>

</body>
</html>
